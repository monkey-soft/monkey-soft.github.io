---
layout: post
title:  "高并发的那些事"
date:   2018-10-05 19:44:01
urlname: 80
cover: https://img.jikehou.cn/cover/2018-10-05.jpg
categories: [网络基础]
tags: [高并发]
keywords: [高并发]
---
"高并发"对后台开发同学来说，既熟悉又陌生。

熟悉是因为面试和工作经常会提及它。

陌生的原由是服务器因高并发导致出现各位问题的情况少之又少。

同时，想收获这方面的经验也是"摸着石头过河"， 需要大量学习理论知识，再去探索。

如果是客户端开发的同学，字典中是没有“高并发”这个名词。

这验证一句老话，"隔行如隔山"。

客户端开发，特别是手机应用开发，更多地是考虑如何优化应用的性能，降低 App 的卡顿率等。

本文是一篇科普文，分享自己近来学到的知识。
<!-- more -->
## 1.什么是高并发？
由于分布式系统的问世，高并发（High Concurrency）通常是指通过设计保证系统能够同时并行处理很多请求。

通俗来讲，高并发是指在同一个时间点，有很多用户同时的访问同一 API 接口或者 Url 地址。

它经常会发生在有大活跃用户量，用户高聚集的业务场景中。

其实，高并发也离我们的生活并不遥远。

例如大学学校的选课系统，一到选课的时候，一大批学生同时选课，导致系统出现“不良反应”；

再如淘宝的 618 和 双 11 的购物活动；遇到节假日，12306 上演的“抢票大战”。

另外，DDos 攻击也能算高并发的场景。

## 2.高并发会来带的后果
- 服务端：
    高并发会导致站点服务器/DB服务器资源被占满崩溃，甚至出现服务器宕机的情况；数据的存储不完整，数据更新异常问题。
- 用户端：
    服务端的问题是高并发的直接反馈，而客户端是间隔反馈。它反馈给用户情况是糟糕的体验。

## 3.提高系统并发能力的方式
在这个“云”的时代，提高分布式系统并发能力的方式，方法论上主要有两种：`垂直扩展（Scale Up）`与`水平扩展（Scale Out）`。

### 3-1.垂直扩展
提升单机处理能力。垂直扩展的方式又有两种：
- 增强单机硬件性能，例如：增加 CPU 核数如 32 核，升级更好的网卡如万兆，升级更好的硬盘如 SSD，扩充硬盘容量如 2T，扩充系统内存如 128G；
 
- 提升单机架构性能，例如：使用 Cache 来减少 I/O 次数，使用异步来增加单服务吞吐量，使用无锁数据结构来减少响应时间；

### 3-2.水平扩展
只要增加服务器数量，就能线性扩充系统性能。

虚拟化技术的出现，让水平扩展变得轻松且简单。

现在的云主机几乎是虚拟主机，而不是物理主机。

这样的话，线性扩充也就是分分钟的事，前提是要有足够的物理主机支撑。

## 4.高并发的三个经典问题
### 4-1.单台服务器最大并发

单台服务器最大并发问题，一般是指一台服务器能够支持多少TCP并发连接.

一种理论说法是受到端口号范围限制。

操作系统上端口号 1024 以下是系统保留的，从 1024-65535 是用户使用的。

由于每个TCP连接都要占一个端口号，所以我们最多可以有 60000 多个并发连接。

但实际上单机并发连接数肯定要受硬件资源（内存、网卡）、网络资源（带宽）的限制。

特别是网卡处理数据的能力，它是最大并发的瓶颈。
    
### 4-2.C10K并发连接问题

C10K并发连接问题是指单机 1 万个并发连接问题。

如何突破单机性能局限，是高性能网络编程所必须要直面的问题。这些局限和问题最早被 Dan Kegel 进行了归纳和总结，并首次成系统地分析和提出解决方案，后来这种普遍的网络现象和技术局限都被大家称为 C10K 问题 。
    
C10K问题本质上是操作系统的问题。

对于 Web1.0/2.0 时代的操作系统而言，传统的同步阻塞 I/O 模型都是一样的，处理的方式都是 requests per second，并发 10K 和 100 的区别关键在于CPU。

创建的进程线程多了，数据拷贝频繁（缓存I/O、内核将数据拷贝到用户进程空间、阻塞），进程/线程上下文切换消耗大，导致操作系统崩溃，这就是C10K问题的本质！
    
### 4-3.C10M并发连接问题

回顾了过去的 10 年里，我们面临高性能网络编程领域著名的C10K问题，最终也成功提出解决方案。

下一个 10 年，是时候考虑 C10M 并发问题了。

C10M 并发连接问题指的是单机服务器实现 C10M（即单机千万并发连接）。

## 5.Django 与高并发的联系
想弄清楚这个问题，首先要了解下 Django 在服务器中所处的位置。

![Django 与高并发的联系](https://img.jikehou.cn/img/113_1.jpg)

上图中讲到 Django 应用服务器可以分为三层：
- Web 框架层
    Web框架层就是我们开发出来的 Django Web 应用程序。它负责处理 HTTP 请求的动态数据。

- WSGI 层
    WSGI 不是用于与程序交互的API，也不是真实的代码，WSGI 只是一种接口。它只适用于 Python 语言，其全称为 Web Server Gateway Interface。其定义了 web服务器和 web应用之间的接口规范。

- Web 服务器层
    Web 服务层作用是主要是接收 HTTP 请求并返回响应。常见的 web服务器有 Nginx，Apache，IIS等。
    
    特别是 Nginx, 它的出现是为了解决 C10K 问题。Nginx 依靠异步事件驱动架构来帮助其处理大量的并发会话，由于其对资源的轻量利用和伸缩自如的特性，它成为了广受欢迎的 web 服务器。

Django 框架注重的数据交互。所以考虑的问题是 Django 适不适合于高并发的场景。

它是一个经过大型网站规模验证的框架。

Instagram 支撑上亿日活，所以 Django 能适用于高并发场景。

所以不是想着 Django 框架能支撑到多大的并发量，而是我们想要抗住很大的并发量，怎么优化现有框架。

